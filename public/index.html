<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>晚餐推薦測試頁</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 720px; margin: 40px auto; line-height: 1.6; }
    h1 { font-size: 24px; margin-bottom: 16px; }
    .row { margin-bottom: 12px; }
    label { display: inline-block; width: 90px; }
    input { padding: 6px 8px; width: 200px; }
    button { padding: 8px 12px; cursor: pointer; }
    .result { white-space: pre-wrap; background: #f6f8fa; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .error { color: #b91c1c; }
    .muted { color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <h1>晚餐推薦測試頁</h1>

  <div class="row">
    <button id="btnGPS">使用目前位置推薦</button>
    <span class="muted">首次使用請允許瀏覽器取得定位。</span>
  </div>

  <div class="row">
    <label>緯度 lat</label>
    <input id="lat" type="text" placeholder="例如 25.033" />
  </div>
  <div class="row">
    <label>經度 lng</label>
    <input id="lng" type="text" placeholder="例如 121.565" />
  </div>
  <div class="row">
    <label>距離(公尺)</label>
    <input id="maxDistance" type="number" value="6000" />
  </div>
  <div class="row">
    <button id="btnManual">使用輸入座標推薦</button>
  </div>

  <h2>結果</h2>
  <div id="status" class="muted"></div>
  <div id="result" class="result"></div>

  <h2>記錄這次用餐</h2>
<div class="row">
  <label>評分</label>
  <input id="rating" type="number" min="1" max="5" placeholder="1~5" />
</div>
<div class="row">
  <label>心得</label>
  <input id="note" type="text" placeholder="今天的感想..." />
</div>
<div class="row">
  <button id="btnSave">記錄這次用餐</button>
</div>

<h2>歷史紀錄</h2>
<div class="row">
  <button id="btnHistory">取得歷史紀錄</button>
</div>
<div id="history" class="result"></div>


  <script>
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const latEl = document.getElementById('lat');
    const lngEl = document.getElementById('lng');
    const maxEl = document.getElementById('maxDistance');
    let lastRecommended = null; // 用來保存最近的一筆推薦結果

    const ratingEl = document.getElementById('rating');
    const noteEl = document.getElementById('note');
    const historyEl = document.getElementById('history');


    function setStatus(msg, isError = false) {
      statusEl.textContent = msg || '';
      statusEl.className = isError ? 'error' : 'muted';
    }

    function showResult(json) {
        lastRecommended = json;  // 保存最近推薦
      // 友善顯示常用欄位，底下再附完整 JSON
      const lines = [];
      if (json && typeof json === 'object') {
        lines.push(`名稱：${json.name ?? ''}`);
        lines.push(`類型：${json.type ?? ''}`);
        lines.push(`評分：${json.rating ?? ''}`);
        lines.push(`價位：${json.priceLevel ?? ''}`);
        lines.push(`地址：${json.address ?? ''}`);
        if (json.location && Array.isArray(json.location.coordinates)) {
          lines.push(`座標：[${json.location.coordinates.join(', ')}]`);
        }
        lines.push('');
        lines.push('完整 JSON：');
        lines.push(JSON.stringify(json, null, 2));
      } else {
        lines.push(String(json));
      }
      resultEl.textContent = lines.join('\n');
    }

    async function recommend(lat, lng, maxDistance) {
      setStatus('呼叫後端中…');
      resultEl.textContent = '';
      try {
        const url = `/api/recommend?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&maxDistance=${encodeURIComponent(maxDistance)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) {
          setStatus(`發生錯誤：${data.message || res.status}`, true);
          showResult(data);
          return;
        }
        setStatus('完成');
        showResult(data);
      } catch (err) {
        setStatus('網路或伺服器錯誤', true);
        showResult(String(err));
      }
    }

    document.getElementById('btnGPS').addEventListener('click', () => {
      if (!navigator.geolocation) {
        setStatus('此瀏覽器不支援定位', true);
        return;
      }
      setStatus('取得定位中…');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          latEl.value = lat.toFixed(6);
          lngEl.value = lng.toFixed(6);
          const maxDistance = Number(maxEl.value) || 6000;
          recommend(lat, lng, maxDistance);
        },
        err => {
          setStatus(`定位失敗：${err.message}`, true);
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    document.getElementById('btnManual').addEventListener('click', () => {
      const lat = parseFloat(latEl.value);
      const lng = parseFloat(lngEl.value);
      const maxDistance = Number(maxEl.value) || 6000;
      if (Number.isNaN(lat) || Number.isNaN(lng)) {
        setStatus('請輸入有效的緯度與經度', true);
        return;
      }
      recommend(lat, lng, maxDistance);
    });
    // 記錄這次用餐
document.getElementById('btnSave').addEventListener('click', async () => {
  if (!lastRecommended || !lastRecommended._id) {
    setStatus('沒有可記錄的餐廳，請先取得推薦', true);
    return;
  }
  const payload = {
    userId: 'guest',
    restaurantId: lastRecommended._id,
    restaurantName: lastRecommended.name,
    rating: ratingEl.value ? Number(ratingEl.value) : undefined,
    note: noteEl.value || ''
  };

  try {
    setStatus('送出紀錄中…');
    const res = await fetch('/api/meals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) {
      setStatus(`儲存失敗：${data.message || res.status}`, true);
      return;
    }
    setStatus(`儲存成功，紀錄編號：${data.recordId}`);
    ratingEl.value = '';
    noteEl.value = '';
  } catch (err) {
    setStatus('網路或伺服器錯誤', true);
  }
});

// 取得歷史紀錄
document.getElementById('btnHistory').addEventListener('click', async () => {
  try {
    setStatus('讀取歷史紀錄中…');
    historyEl.textContent = '';
    const res = await fetch('/api/meals/history?userId=guest&limit=20');
    const list = await res.json();
    if (!res.ok) {
      setStatus(`讀取失敗：${list.message || res.status}`, true);
      return;
    }
    const lines = list.map(item => {
      const d = new Date(item.date);
      const dateStr = isNaN(d.getTime()) ? '' : d.toLocaleString();
      return `• ${dateStr}  ${item.restaurantName}  評分:${item.rating ?? ''}  備註:${item.note ?? ''}`;
    });
    historyEl.textContent = lines.length ? lines.join('\n') : '目前沒有紀錄';
    setStatus('完成');
  } catch (err) {
    setStatus('網路或伺服器錯誤', true);
  }
});

  </script>
</body>
</html>
